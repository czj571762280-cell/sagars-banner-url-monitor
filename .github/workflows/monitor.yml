name: Detect URL Once and Notify

on:
  schedule:
    - cron: '*/30 * * * *'   # æ¯30åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install requests

      - name: Run one-time monitor
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          TARGET_URLS: |
            https://dy2q74h86jiwd.cloudfront.net/static/images/info/130849/news_banner_20251008.png
            https://dy2q74h86jiwd.cloudfront.net/static/images/info/130849/news_banner_20251200.png
        run: |
          python3 - <<'PY'
          import os, requests, smtplib, ssl
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime

          smtp_server = os.environ['SMTP_SERVER']
          smtp_port = int(os.environ['SMTP_PORT'])
          username = os.environ['SMTP_USERNAME']
          password = os.environ['SMTP_PASSWORD']
          to_email = os.environ['TO_EMAIL']

          # å¤šè¡Œå†™æ³•å¤„ç†
          urls_raw = os.environ['TARGET_URLS']
          urls = [u.strip() for u in urls_raw.splitlines() if u.strip()]

          context = ssl.create_default_context()
          done_flag = "done.flag"

          if os.path.exists(done_flag):
              print("âœ… æ£€æµ‹å·²å®Œæˆï¼ˆå­˜åœ¨ done.flagï¼‰ï¼Œä¸å†æ‰§è¡Œã€‚")
              exit(0)

          has_info_urls = []

          for url in urls:
              print(f"ğŸ” æ£€æŸ¥ï¼š{url}")
              try:
                  r = requests.get(url, timeout=30)
                  r.raise_for_status()
                  text = r.text.strip()
                  if len(text) > 0:
                      print(f"âš ï¸ å‘ç° {url} æœ‰å†…å®¹ï¼")
                      has_info_urls.append(url)
                  else:
                      print(f"âœ… {url} ä¸ºç©ºï¼Œæ— ä¿¡æ¯ã€‚")
              except Exception as e:
                  print(f"âŒ {url} è¯·æ±‚å¤±è´¥ï¼š{e}")

          if has_info_urls:
              msg = MIMEMultipart("alternative")
              msg["Subject"] = "æ£€æµ‹åˆ°ç½‘é¡µæœ‰å†…å®¹"
              msg["From"] = username
              msg["To"] = to_email
              body = f"æ—¶é—´ï¼š{datetime.now()}\nä»¥ä¸‹ç½‘å€æ£€æµ‹åˆ°éç©ºå†…å®¹ï¼š\n" + "\n".join(has_info_urls)
              msg.attach(MIMEText(body, "plain"))

              try:
                  if smtp_port == 465:
                      with smtplib.SMTP_SSL(smtp_server, smtp_port, context=context) as server:
                          server.login(username, password)
                          server.sendmail(username, to_email, msg.as_string())
                  else:
                      with smtplib.SMTP(smtp_server, smtp_port) as server:
                          server.starttls(context=context)
                          server.login(username, password)
                          server.sendmail(username, to_email, msg.as_string())
                  print("ğŸ“§ é‚®ä»¶å‘é€æˆåŠŸï¼")
              except Exception as e:
                  print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼š{e}")

              with open(done_flag, "w") as f:
                  f.write("done")
              print("âœ… å·²ç”Ÿæˆ done.flagï¼Œä¸‹æ¬¡å°†è‡ªåŠ¨åœæ­¢æ£€æµ‹ã€‚")
          else:
              print("â³ æ‰€æœ‰ç½‘å€éƒ½ä¸ºç©ºï¼Œæœªå‘ç°å†…å®¹ã€‚")
          PY
