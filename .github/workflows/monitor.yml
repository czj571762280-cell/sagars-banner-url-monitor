name: Monitor URL and Send Email

on:
  schedule:
    - cron: '*/30 * * * *'   # æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:          # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆå¯åœ¨Actionsç•Œé¢ç‚¹Runï¼‰

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install requests

      - name: Run monitor script
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          TARGET_URL: ${{ secrets.TARGET_URL }}
        run: |
          python3 - <<'PY'
          import smtplib, ssl, requests, hashlib, os
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from datetime import datetime

          url = os.environ['TARGET_URL']
          smtp_server = os.environ['SMTP_SERVER']
          smtp_port = int(os.environ['SMTP_PORT'])
          username = os.environ['SMTP_USERNAME']
          password = os.environ['SMTP_PASSWORD']
          to_email = os.environ['TO_EMAIL']

          hash_file = "last_hash.txt"

          # è·å–ç½‘é¡µå†…å®¹å¹¶è®¡ç®—å“ˆå¸Œ
          try:
              r = requests.get(url, timeout=30)
              r.raise_for_status()
              new_hash = hashlib.sha256(r.content).hexdigest()
          except Exception as e:
              print("âŒ è¯·æ±‚å¤±è´¥ï¼š", e)
              exit(1)

          old_hash = None
          if os.path.exists(hash_file):
              old_hash = open(hash_file).read().strip()

          if old_hash != new_hash:
              print("ğŸ”” æ£€æµ‹åˆ°ç½‘é¡µå†…å®¹å˜åŒ–ï¼Œå‘é€é‚®ä»¶é€šçŸ¥ï¼")

              # æ„é€ é‚®ä»¶
              msg = MIMEMultipart("alternative")
              msg["Subject"] = f"ç½‘é¡µæ›´æ–°é€šçŸ¥ï¼š{url}"
              msg["From"] = username
              msg["To"] = to_email
              text = f"æ—¶é—´ï¼š{datetime.now()}\nç½‘å€ï¼š{url}\n\næ£€æµ‹åˆ°ç½‘é¡µå†…å®¹å‘ç”Ÿå˜åŒ–ã€‚"
              msg.attach(MIMEText(text, "plain"))

              # å‘é€é‚®ä»¶
              context = ssl.create_default_context()
              try:
                  if smtp_port == 465:
                      with smtplib.SMTP_SSL(smtp_server, smtp_port, context=context) as server:
                          server.login(username, password)
                          server.sendmail(username, to_email, msg.as_string())
                  else:
                      with smtplib.SMTP(smtp_server, smtp_port) as server:
                          server.starttls(context=context)
                          server.login(username, password)
                          server.sendmail(username, to_email, msg.as_string())
                  print("âœ… é‚®ä»¶å·²å‘é€æˆåŠŸï¼")
              except Exception as e:
                  print("âŒ é‚®ä»¶å‘é€å¤±è´¥ï¼š", e)

              # ä¿å­˜æœ€æ–°å“ˆå¸Œ
              with open(hash_file, "w") as f:
                  f.write(new_hash)
          else:
              print(f"{datetime.now()} - å†…å®¹æ— å˜åŒ–ã€‚")
          PY
